<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Practice | One English</title>
    
    <link rel="icon" type="image/png" href="https://drive.google.com/thumbnail?id=1CId639VyMXaFjtG6dZMkjP_xewS1z8lH&sz=w128">
    <link rel="apple-touch-icon" href="https://drive.google.com/thumbnail?id=1CId639VyMXaFjtG6dZMkjP_xewS1z8lH&sz=w512">
    <meta name="theme-color" content="#2C4A84">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Lora:ital,wght@1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* === VARIABLES & RESET === */
        :root {
            --oe-navy: #2C4A84; --oe-cyan: #2AA6C4; --oe-sky: #3BB6D6;
            --bg-body: #F4F7F9; --bg-card: #FFFFFF;
            --text-main: #1E293B; --text-muted: #64748B;
            --success: #10B981; --error: #EF4444; --warning: #F59E0B;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 80px; }

        /* === PANTALLA BIENVENIDA === */
        #welcome-screen {
            position: fixed; inset: 0; background: var(--bg-card); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;
        }
        .logo-box { width: 100px; height: 100px; border-radius: 20px; box-shadow: 0 10px 20px rgba(44,74,132,0.15); overflow: hidden; margin-bottom: 20px; }
        .logo-box img { width: 100%; height: 100%; object-fit: cover; }
        .input-name { width: 100%; max-width: 300px; padding: 15px; border-radius: 12px; border: 2px solid #E2E8F0; text-align: center; font-size: 1.1rem; font-weight: 700; color: var(--oe-navy); margin-bottom: 20px; outline: none; }
        .input-name:focus { border-color: var(--oe-cyan); }
        .btn-start { background: var(--oe-navy); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: 800; font-size: 1.1rem; cursor: pointer; box-shadow: 0 10px 20px rgba(44,74,132,0.2); }

        /* === HEADER & TABS === */
        #app-root { display: none; max-width: 800px; margin: 0 auto; }
        .header { background: var(--bg-card); padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .student-badge { display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--oe-navy); }
        .btn-logout { background: #F1F5F9; border: none; width: 35px; height: 35px; border-radius: 50%; color: var(--error); cursor: pointer; }

        .tabs { display: flex; gap: 10px; padding: 15px 20px; background: var(--bg-body); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; background: #E2E8F0; color: var(--text-muted); cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--oe-navy); color: white; }
        .tab-btn.locked { opacity: 0.5; background: #CBD5E1; cursor: not-allowed; }

        /* === PREGUNTAS INLINE === */
        .module { display: none; padding: 0 20px; animation: slideUp 0.4s ease; }
        .module.active { display: block; }
        @keyframes slideUp { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }

        .info-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .q-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 12px; font-size: 1.1rem; color: var(--text-main); font-weight: 500; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; border: 1px solid #E2E8F0; }
        .q-num { font-weight: 800; color: var(--oe-cyan); width: 25px; }
        
        /* El input dentro de la oraci√≥n */
        .inline-input {
            width: 100px; padding: 5px 10px; border: 2px solid #CBD5E1; border-radius: 8px;
            font-family: 'Poppins'; font-size: 1rem; font-weight: 700; color: var(--oe-navy);
            text-align: center; background: #F8FAFC; outline: none; transition: 0.3s;
        }
        .inline-input:focus { border-color: var(--oe-cyan); background: white; width: 120px; }
        .inline-input.correct { border-color: var(--success); background: #ECFDF5; color: var(--success); pointer-events: none; }
        .inline-input.wrong { border-color: var(--error); background: #FEF2F2; color: var(--error); animation: shake 0.4s; }

        @keyframes shake { 10%, 90% {transform: translateX(-2px);} 20%, 80% {transform: translateX(3px);} 30%, 50%, 70% {transform: translateX(-4px);} 40%, 60% {transform: translateX(4px);} }

        .btn-submit { width: 100%; padding: 18px; border-radius: 12px; background: var(--oe-navy); color: white; border: none; font-weight: 800; font-size: 1.1rem; margin-top: 20px; cursor: pointer; box-shadow: 0 5px 15px rgba(44,74,132,0.2); }

        /* === STATUS & TOASTS === */
        .lives-badge { background: #FEF2F2; color: var(--error); padding: 8px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 15px; border: 1px solid #FCA5A5; }
        
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: white; padding: 15px 20px; border-radius: 30px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-left: 4px solid var(--oe-cyan); display: flex; align-items: center; gap: 10px; animation: dropIn 0.3s, fadeOut 0.3s 3.5s forwards; }
        @keyframes dropIn { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
        @keyframes fadeOut { to{opacity:0;} }

        /* MODAL */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; animation: pop 0.3s; }
        @keyframes pop { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <div class="logo-box"><img src="https://drive.google.com/thumbnail?id=1CId639VyMXaFjtG6dZMkjP_xewS1z8lH&sz=w200"></div>
        <h1 style="color:var(--oe-navy); font-family:'Lora'; margin-bottom:5px;">Intensive Lab</h1>
        <p style="color:var(--text-muted); font-weight:500; margin-bottom:30px;">Verb To Be & There is/are</p>
        <input type="text" id="student-name" class="input-name" placeholder="Escribe tu nombre..." autocomplete="off">
        <button class="btn-start" onclick="login()">COMENZAR</button>
    </div>

    <div id="toast-box"></div>

    <div id="app-root">
        <header class="header">
            <div style="font-weight:800; color:var(--oe-cyan);"><i class="fas fa-bolt"></i> One English</div>
            <div class="student-badge">
                <span id="ui-name">Name</span>
                <button class="btn-logout" onclick="resetAllData()" title="Cerrar Sesi√≥n"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" id="btn-ws" onclick="openTab('ws')">1. Worksheet</button>
            <button class="tab-btn locked" id="btn-wp" onclick="openTab('wp')">2. Written Practice <i class="fas fa-lock" id="icon-wp" style="font-size:0.8rem;"></i></button>
        </div>

        <div id="mod-ws" class="module active">
            <div class="info-card" style="border-color:var(--oe-cyan);">
                <h3 style="color:var(--oe-navy);">Fase 1: Worksheet</h3>
                <p style="font-size:0.9rem; color:var(--text-muted);">Completa las 20 oraciones para desbloquear la prueba final. Tu progreso se guardar√° autom√°ticamente.</p>
            </div>
            <div id="ws-content"></div>
            <button class="btn-submit" onclick="checkWorksheet()"><i class="fas fa-check"></i> CALIFICAR WORKSHEET</button>
        </div>

        <div id="mod-wp" class="module">
            <div class="info-card" style="border-color:var(--warning); background:#FFFBEB;">
                <h3 style="color:#92400E;">Fase 2: Reto Final</h3>
                <p style="font-size:0.9rem; color:#B45309;">Nivel estricto. Escribe la respuesta correcta.</p>
            </div>
            <div class="lives-badge" id="lives-counter"><i class="fas fa-heart"></i> Tienes 3 intentos</div>
            <div id="wp-content"></div>
            <button class="btn-submit" style="background:var(--warning); color:#92400E;" onclick="checkWritten()"><i class="fas fa-flag-checkered"></i> ENTREGAR EXAMEN</button>
        </div>
    </div>

    <div class="modal-bg" id="modal">
        <div class="modal-card">
            <div id="mod-icon" style="font-size:4rem; margin-bottom:10px;">üèÜ</div>
            <h2 id="mod-title" style="color:var(--oe-navy); margin-bottom:10px;">T√≠tulo</h2>
            <p id="mod-body" style="color:var(--text-muted); margin-bottom:20px;">Mensaje</p>
            <button class="btn-start" style="width:100%;" id="mod-btn">Aceptar</button>
        </div>
    </div>

    <script>
        /* ==================================================
           BASE DE DATOS (20 c/u, con "split" para Inputs Inline)
           ================================================== */
        // Formato: pre = Texto antes, post = Texto despu√©s
        const db_ws = [
            { pre: "She", post: "my best friend.", ans: ["is", "'s"] },
            { pre: "I", post: "25 years old.", ans: ["am", "'m"] },
            { pre: "They", post: "at the cinema.", ans: ["are", "'re"] },
            { pre: "", post: "you happy today?", ans: ["are"] },
            { pre: "It", post: "a beautiful dog.", ans: ["is", "'s"] },
            { pre: "We", post: "not hungry.", ans: ["are", "'re"] },
            { pre: "The cat", post: "under the table.", ans: ["is"] },
            { pre: "My parents", post: "teachers.", ans: ["are"] },
            { pre: "", post: "he your brother?", ans: ["is"] },
            { pre: "I", post: "(not) sad.", ans: ["am not", "'m not"] },
            { pre: "", post: "a book on the desk.", ans: ["there is", "there's"] },
            { pre: "", post: "many people here.", ans: ["there are", "there're"] },
            { pre: "", post: "any milk in the fridge?", ans: ["is there"] },
            { pre: "", post: "two cars in the garage.", ans: ["there are", "there're"] },
            { pre: "", post: "a spider in my room!", ans: ["there is", "there's"] },
            { pre: "", post: "5 students in the class.", ans: ["there are", "there're"] },
            { pre: "No,", post: "not any money.", ans: ["there is", "there's"] },
            { pre: "", post: "a problem with my phone.", ans: ["there is", "there's"] },
            { pre: "How many chairs", post: "?", ans: ["are there"] },
            { pre: "", post: "only one option.", ans: ["there is", "there's"] }
        ];

        const db_wp = [
            { pre: "I", post: "(not) a doctor.", ans: ["am not", "'m not"] },
            { pre: "", post: "(She) your sister?", ans: ["is she"] },
            { pre: "They", post: "(not) at home.", ans: ["are not", "aren't", "'re not"] },
            { pre: "", post: "(There is) a book here.", ans: ["there is", "there's"] },
            { pre: "", post: "(There are) two dogs.", ans: ["there are"] },
            { pre: "We", post: "happy today.", ans: ["are", "'re"] },
            { pre: "It", post: "cold outside.", ans: ["is", "'s"] },
            { pre: "", post: "(not) you tired?", ans: ["are not", "aren't"] },
            { pre: "John", post: "my brother.", ans: ["is", "'s"] },
            { pre: "I", post: "20 years old.", ans: ["am", "'m"] },
            { pre: "", post: "(There) any water?", ans: ["is there"] },
            { pre: "There", post: "(not) any chairs.", ans: ["are not", "aren't"] },
            { pre: "Where", post: "(be) you from?", ans: ["are"] },
            { pre: "What", post: "(be) your name?", ans: ["is", "'s"] },
            { pre: "Who", post: "(be) that man?", ans: ["is", "'s"] },
            { pre: "", post: "(be) they students?", ans: ["are"] },
            { pre: "The car", post: "(be) red.", ans: ["is"] },
            { pre: "My eyes", post: "(be) blue.", ans: ["are"] },
            { pre: "There", post: "(be) a problem.", ans: ["is", "'s"] },
            { pre: "I", post: "(be) not hungry.", ans: ["am", "'m"] }
        ];

        /* ==================================================
           SISTEMA DE MEMORIA (LOCAL STORAGE) & VARIABLES
           ================================================== */
        let student = "";
        let isWsPassed = false;
        let wpAttempts = 0;
        const MAX_ATTEMPTS = 3;

        function checkMemory() {
            student = localStorage.getItem('oe_student');
            isWsPassed = localStorage.getItem('oe_ws_passed') === 'true';
            wpAttempts = parseInt(localStorage.getItem('oe_wp_attempts')) || 0;

            if(student) {
                document.getElementById('ui-name').innerText = student;
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('app-root').style.display = 'block';
                
                if(isWsPassed) {
                    unlockWP();
                    toast(`¬°Qu√© bueno verte de nuevo, ${student}! Fase 2 desbloqueada.`);
                } else {
                    toast(`¬°Hola de nuevo, ${student}! Sigamos practicando.`);
                }
                updateLivesUI();
            }
        }

        /* ==================================================
           L√ìGICA DE INTERFAZ & RENDERIZADO
           ================================================== */
        function login() {
            const val = document.getElementById('student-name').value.trim();
            if(val.length < 2) return toast("Por favor, escribe tu nombre.", "error");
            
            student = val;
            localStorage.setItem('oe_student', student);
            document.getElementById('ui-name').innerText = student;
            
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('app-root').style.display = 'block';
            toast(`¬°Bienvenido al reto, ${student}!`);
        }

        function renderInline(containerId, dataArray, prefix) {
            const box = document.getElementById(containerId);
            let html = "";
            dataArray.forEach((q, i) => {
                const ansStr = JSON.stringify(q.ans).replace(/"/g, '&quot;');
                html += `
                <div class="q-card">
                    <span class="q-num">${i+1}.</span>
                    <span>${q.pre} <input type="text" id="${prefix}-${i}" class="inline-input ${prefix}-in" data-ans="${ansStr}" autocomplete="off" spellcheck="false"> ${q.post}</span>
                </div>`;
            });
            box.innerHTML = html;
        }

        function openTab(id) {
            if(id === 'wp' && !isWsPassed) return toast(`üîí Necesitas 20/20 en el Worksheet primero.`, "error");
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            
            document.getElementById(`btn-${id}`).classList.add('active');
            document.getElementById(`mod-${id}`).classList.add('active');
            window.scrollTo(0,0);
        }

        function unlockWP() {
            isWsPassed = true;
            localStorage.setItem('oe_ws_passed', 'true');
            const btn = document.getElementById('btn-wp');
            btn.classList.remove('locked');
            document.getElementById('icon-wp').className = 'fas fa-unlock';
        }

        /* ==================================================
           SISTEMA DE VERIFICACI√ìN (WS y WP)
           ================================================== */
        function processInputs(selector) {
            let correct = 0;
            const inputs = document.querySelectorAll(selector);
            
            inputs.forEach(input => {
                if(input.classList.contains('correct')) { correct++; return; } // Ya estaba bien
                
                let val = input.value.trim().toLowerCase().replace(/‚Äò|‚Äô/g, "'");
                let ansArray = JSON.parse(input.getAttribute('data-ans'));

                if(ansArray.includes(val)) {
                    input.className = `inline-input ${selector.replace('.','')} correct`;
                    input.readOnly = true;
                    correct++;
                } else {
                    input.className = `inline-input ${selector.replace('.','')} wrong`;
                }
            });
            return { correct, total: inputs.length };
        }

        // WORKSHEET (Sin l√≠mite de intentos)
        function checkWorksheet() {
            const res = processInputs('.ws-in');
            
            if(res.correct === res.total) {
                unlockWP();
                confetti();
                modal("¬°Fase 1 Completada! üèÜ", `¬°Perfecto ${student}! Tienes 20/20. Tu progreso est√° guardado. Pasa al Reto Escrito.`, () => {
                    closeModal(); openTab('wp');
                });
            } else {
                toast(`Te faltan ${res.total - res.correct}. Corrige las casillas rojas.`, "error");
            }
        }

        // WRITTEN PRACTICE (3 Intentos)
        function checkWritten() {
            const res = processInputs('.wp-in');

            if(res.correct === res.total) {
                // GANADOR
                localStorage.setItem('oe_wp_attempts', '0'); // Reset memory
                confetti({particleCount: 150});
                modal("¬°CERTIFICADO! üåü", `¬°Impresionante, ${student}! Lograste el 20/20 en el nivel m√°s dif√≠cil. Eres un m√°ster del Verb To Be.`, () => location.reload());
                document.getElementById('mod-btn').innerText = "Finalizar";
                return;
            }

            // FALL√ì
            wpAttempts++;
            localStorage.setItem('oe_wp_attempts', wpAttempts.toString());
            updateLivesUI();

            if(wpAttempts >= MAX_ATTEMPTS) {
                // GAME OVER - Reiniciar WP
                modal("L√≠mite Alcanzado üíî", `Se acabaron tus 3 intentos, ${student}. El Reto Escrito se reiniciar√° para que lo intentes de nuevo (Tu Worksheet est√° a salvo).`, () => {
                    wpAttempts = 0;
                    localStorage.setItem('oe_wp_attempts', '0');
                    renderInline('wp-content', db_wp, 'wp'); // Borra todo y redibuja
                    updateLivesUI();
                    closeModal();
                }, "üîÑ");
            } else {
                toast(`Error. Te quedan ${MAX_ATTEMPTS - wpAttempts} intentos. Corrige las rojas.`, "warning");
            }
        }

        function updateLivesUI() {
            const box = document.getElementById('lives-counter');
            const rem = MAX_ATTEMPTS - wpAttempts;
            box.innerHTML = `<i class="fas fa-heart"></i> Tienes ${rem} intento${rem === 1 ? '' : 's'}`;
            if(rem === 1) { box.style.background = "var(--error)"; box.style.color = "white"; }
            else { box.style.background = "#FEF2F2"; box.style.color = "var(--error)"; }
        }

        /* ==================================================
           UTILIDADES (BORRAR DATOS, TOASTS Y MODALS)
           ================================================== */
        function resetAllData() {
            if(confirm("¬øSeguro que quieres borrar tu usuario y empezar desde cero?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function toast(msg, type="success") {
            const box = document.getElementById('toast-box');
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.borderLeftColor = type === 'error' ? 'var(--error)' : type === 'warning' ? 'var(--warning)' : 'var(--oe-cyan)';
            t.innerHTML = `<i class="fas fa-${type==='success'?'check':type==='error'?'times':'exclamation'}-circle" style="color:${t.style.borderLeftColor}"></i> ${msg}`;
            box.appendChild(t);
            setTimeout(() => t.remove(), 3800);
        }

        function modal(title, body, fn, icon="üèÜ") {
            document.getElementById('mod-title').innerText = title;
            document.getElementById('mod-body').innerText = body;
            document.getElementById('mod-icon').innerText = icon;
            const btn = document.getElementById('mod-btn');
            btn.onclick = fn;
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // Inicializar
        window.onload = () => {
            renderInline('ws-content', db_ws, 'ws');
            renderInline('wp-content', db_wp, 'wp');
            checkMemory();
        };

    </script>
</body>
</html>
